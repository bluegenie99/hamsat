/**
 * خدمة تشكيل النص العربي
 */

// ملاحظة: في التطبيق الحقيقي، سنحتاج إلى مفتاح API للتشكيل

/**
 * تشكيل النص العربي باستخدام API خارجي
 * نستخدم هنا واجهة محاكاة لأغراض العرض، في التطبيق الحقيقي يمكن استخدام خدمة مثل:
 * - Microsoft Text Analytics API
 * - Google Cloud Natural Language API
 * - Tashkeel API
 * 
 * @param text النص المراد تشكيله
 * @returns وعد يتم حله بالنص المشكل
 */
export const addDiacritics = async (text: string): Promise<string> => {
  // في الإصدار الحقيقي، سنرسل طلبًا إلى API خارجي
  // لكن هنا سنستخدم محاكاة بسيطة لإضافة بعض التشكيل
  
  try {
    // محاكاة تأخير الشبكة
    await new Promise(resolve => setTimeout(resolve, 100));
    
    // قائمة بالكلمات العربية الشائعة مع تشكيلها
    const diacriticsMap: Record<string, string> = {
      // ضمائر
      'انا': 'أَنَا',
      'انت': 'أَنْتَ',
      'انتي': 'أَنْتِي',
      'انتم': 'أَنْتُمْ',
      'انتن': 'أَنْتُنَّ',
      'هو': 'هُوَ',
      'هي': 'هِيَ',
      'هم': 'هُمْ',
      'هن': 'هُنَّ',
      'نحن': 'نَحْنُ',
      
      // تحيات وعبارات مجاملة
      'اهلا': 'أَهْلًا',
      'وسهلا': 'وَسَهْلًا',
      'مرحبا': 'مَرْحَبًا',
      'صباح': 'صَبَاحَ',
      'الخير': 'الْخَيْرِ',
      'مساءا': 'مَسَاءً',
      'النور': 'النُّورِ',
      'تصبح': 'تُصْبِحُ',
      'على': 'عَلَى',
      'خير': 'خَيْرٍ',
      'كيف': 'كَيْفَ',
      'حالك': 'حَالُكَ',
      'بخير': 'بِخَيْرٍ',
      'الحمد': 'الْحَمْدُ',
      'لله': 'لِلَّهِ',
      'شكرا': 'شُكْرًا',
      'جزيلا': 'جَزِيلًا',
      'عفوا': 'عَفْوًا',
      'اسف': 'آسِفٌ',
      'اسفة': 'آسِفَةٌ',
      'سامحني': 'سَامِحْنِي',
      
      // كلمات استفهام
      'ماذا': 'مَاذَا',
      'متى': 'مَتَى',
      'اين': 'أَيْنَ',
      'لماذا': 'لِمَاذَا',
      'هل': 'هَلْ',
      'ما': 'مَا',
      'كم': 'كَمْ',
      'اي': 'أَيُّ',
      
      // حروف جر وعطف
      'حتى': 'حَتَّى',
      'منذ': 'مُنْذُ',
      'و': 'وَ',
      'ثم': 'ثُمَّ',
      'او': 'أَوْ',
      'لكن': 'لَكِنْ',
      'بل': 'بَلْ',
      'ف': 'فَ',
      
      // أسماء إشارة وموصولة
      'الذي': 'الَّذِي',
      'التي': 'الَّتِي',
      'الذين': 'الَّذِينَ',
      'اللاتي': 'اللَّاتِي',
      'اللواتي': 'اللَّوَاتِي',
      'هذا': 'هَذَا',
      'هذه': 'هَذِهِ',
      'هؤلاء': 'هَؤُلَاءِ',
      'ذلك': 'ذَلِكَ',
      'تلك': 'تِلْكَ',
      'اولئك': 'أُولَئِكَ',
      'هنا': 'هُنَا',
      'هناك': 'هُنَاكَ',
      
      // كلمات شائعة
      'نعم': 'نَعَمْ',
      'لا': 'لَا',
      'ربما': 'رُبَّمَا',
      'ممكن': 'مُمْكِنٌ',
      'مستحيل': 'مُسْتَحِيلٌ',
      'يمكن': 'يُمْكِنُ',
      'يجب': 'يَجِبُ',
      'احتاج': 'أَحْتَاجُ',
      'اريد': 'أُرِيدُ',
      'تريد': 'تُرِيدُ',
      'يريد': 'يُرِيدُ',
      'نريد': 'نُرِيدُ',
      'اعرف': 'أَعْرِفُ',
      'تعرف': 'تَعْرِفُ',
      'يعرف': 'يَعْرِفُ',
      'نعرف': 'نَعْرِفُ',
      'افهم': 'أَفْهَمُ',
      'تفهم': 'تَفْهَمُ',
      'يفهم': 'يَفْهَمُ',
      'نفهم': 'نَفْهَمُ',
      'اسمع': 'أَسْمَعُ',
      'تسمع': 'تَسْمَعُ',
      'يسمع': 'يَسْمَعُ',
      'نسمع': 'نَسْمَعُ',
      'اتكلم': 'أَتَكَلَّمُ',
      'تتكلم': 'تَتَكَلَّمُ',
      'يتكلم': 'يَتَكَلَّمُ',
      'نتكلم': 'نَتَكَلَّمُ',
      
      // صفات
      'جميل': 'جَمِيلٌ',
      'جميلة': 'جَمِيلَةٌ',
      'كبير': 'كَبِيرٌ',
      'كبيرة': 'كَبِيرَةٌ',
      'صغير': 'صَغِيرٌ',
      'صغيرة': 'صَغِيرَةٌ',
      'طويل': 'طَوِيلٌ',
      'طويلة': 'طَوِيلَةٌ',
      'قصير': 'قَصِيرٌ',
      'قصيرة': 'قَصِيرَةٌ',
      'جيد': 'جَيِّدٌ',
      'جيدة': 'جَيِّدَةٌ',
      'سيء': 'سَيِّئٌ',
      'سيئة': 'سَيِّئَةٌ',
      'سعيد': 'سَعِيدٌ',
      'سعيدة': 'سَعِيدَةٌ',
      'حزين': 'حَزِينٌ',
      'حزينة': 'حَزِينَةٌ',
      'ذكي': 'ذَكِيٌّ',
      'ذكية': 'ذَكِيَّةٌ',
      'غبي': 'غَبِيٌّ',
      'غبية': 'غَبِيَّةٌ',
      'قوي': 'قَوِيٌّ',
      'قوية': 'قَوِيَّةٌ',
      'ضعيف': 'ضَعِيفٌ',
      'ضعيفة': 'ضَعِيفَةٌ',
      'سريع': 'سَرِيعٌ',
      'سريعة': 'سَرِيعَةٌ',
      'بطيء': 'بَطِيءٌ',
      'بطيئة': 'بَطِيئَةٌ',
      
      // كلمات عاطفية
      'قلب': 'قَلْبٌ',
      'حب': 'حُبٌّ',
      'حبيبي': 'حَبِيبِي',
      'حبيبتي': 'حَبِيبَتِي',
      'عزيزي': 'عَزِيزِي',
      'عزيزتي': 'عَزِيزَتِي',
      'روحي': 'رُوحِي',
      'قلبي': 'قَلْبِي',
      'عيني': 'عَيْنِي',
      'عمري': 'عُمْرِي',
      'حياتي': 'حَيَاتِي',
      'اشتقت': 'اشْتَقْتُ',
      'اشتقتلك': 'اشْتَقْتُ لَكَ',
      'احبك': 'أُحِبُّكَ',
      'اكرهك': 'أَكْرَهُكَ',
      
      // أيام وأشهر
      'اليوم': 'الْيَوْمَ',
      'غدا': 'غَدًا',
      'امس': 'أَمْسِ',
      'الان': 'الْآنَ',
      'بعد': 'بَعْدَ',
      'قبل': 'قَبْلَ',
      'صباحا': 'صَبَاحًا',
      'مساء': 'مَسَاءً',
      'ليلا': 'لَيْلًا',
      'نهارا': 'نَهَارًا',
      'السبت': 'السَّبْتُ',
      'الاحد': 'الْأَحَدُ',
      'الاثنين': 'الْاِثْنَيْنُ',
      'الثلاثاء': 'الثُّلَاثَاءُ',
      'الاربعاء': 'الْأَرْبِعَاءُ',
      'الخميس': 'الْخَمِيسُ',
      'الجمعة': 'الْجُمُعَةُ',
      
      // أرقام
      'واحد': 'وَاحِدٌ',
      'اثنان': 'اثْنَانِ',
      'ثلاثة': 'ثَلَاثَةٌ',
      'اربعة': 'أَرْبَعَةٌ',
      'خمسة': 'خَمْسَةٌ',
      'ستة': 'سِتَّةٌ',
      'سبعة': 'سَبْعَةٌ',
      'ثمانية': 'ثَمَانِيَةٌ',
      'تسعة': 'تِسْعَةٌ',
      'عشرة': 'عَشَرَةٌ',
      'عشرون': 'عِشْرُونَ',
      'ثلاثون': 'ثَلَاثُونَ',
      'اربعون': 'أَرْبَعُونَ',
      'خمسون': 'خَمْسُونَ',
      'ستون': 'سِتُّونَ',
      'سبعون': 'سَبْعُونَ',
      'ثمانون': 'ثَمَانُونَ',
      'تسعون': 'تِسْعُونَ',
      'مئة': 'مِئَةٌ',
      'الف': 'أَلْفٌ',
      'مليون': 'مِلْيُونٌ',
      'مليار': 'مِلْيَارٌ'
    };
    
    // تقسيم النص إلى كلمات
    const words = text.split(' ');
    
    // استبدال الكلمات بنسختها المشكلة إذا كانت موجودة في القائمة
    const diacritizedWords = words.map(word => {
      // إزالة علامات الترقيم للبحث
      const punctuation = word.match(/[.,،؟!:;()"'\[\]{}]/g) || [];
      const cleanWord = word.replace(/[.,،؟!:;()"'\[\]{}]/g, '');
      
      // التعامل مع الكلمات الفارغة
      if (!cleanWord) return word;
      
      // التعامل مع الأرقام والرموز الخاصة
      if (/^[\d\W]+$/.test(cleanWord)) return word;
      
      // التعامل مع الكلمات اللاتينية
      if (/[a-zA-Z]/.test(cleanWord)) return word;
      
      // البحث عن الكلمة في قاموس التشكيل
      const lowerWord = cleanWord.toLowerCase();
      
      // محاولة البحث عن الكلمة بالضبط
      if (diacriticsMap[lowerWord]) {
        // استبدال الكلمة الأصلية بالنسخة المشكلة مع الحفاظ على علامات الترقيم
        let result = diacriticsMap[lowerWord];
        
        // إعادة إضافة علامات الترقيم
        if (punctuation.length > 0) {
          result += punctuation.join('');
        }
        
        return result;
      }
      
      // محاولة البحث عن الكلمة بدون ال التعريف
      if (lowerWord.startsWith('ال') && lowerWord.length > 2) {
        const withoutAl = lowerWord.substring(2);
        if (diacriticsMap[withoutAl]) {
          // إضافة ال التعريف مع تشكيلها
          let result = 'الْ' + diacriticsMap[withoutAl];
          
          // إعادة إضافة علامات الترقيم
          if (punctuation.length > 0) {
            result += punctuation.join('');
          }
          
          return result;
        }
      }
      
      // إذا لم نجد الكلمة، نضيف تشكيل بسيط لتحسين النطق
      // إضافة فتحة على الحرف الأول وسكون على الحرف الأخير
      if (cleanWord.length > 1) {
        const firstChar = cleanWord.charAt(0);
        const lastChar = cleanWord.charAt(cleanWord.length - 1);
        const middleChars = cleanWord.substring(1, cleanWord.length - 1);
        
        // إضافة فتحة على الحرف الأول وسكون على الحرف الأخير
        let result = firstChar + 'َ' + middleChars + lastChar + 'ْ';
        
        // إعادة إضافة علامات الترقيم
        if (punctuation.length > 0) {
          result += punctuation.join('');
        }
        
        return result;
      }
      
      return word;
    });
    
    // إعادة تجميع النص
    return diacritizedWords.join(' ');
    
  } catch (error) {
    console.error('خطأ في تشكيل النص:', error);
    // في حالة الخطأ، نعيد النص الأصلي بدون تشكيل
    return text;
  }
};
